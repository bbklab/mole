#!/bin/bash

basedir="$(cd $(dirname $0);pwd)"


# Func Def
check_rc() {
  if [ $? == 0 ]; then
        echo -e " -- $(date +%F_%T)  succed!  ${*}"
  else
        echo -e " -- $(date +%F_%T)  failed!  ${*}"; exit 1
  fi
}


### Main Body Begin ...
if [ "$1" == "server" -o "$1" == "2" ]; then
  filename="${basedir}/esop_server_build/2_src/init/init_install"
  specfile="${basedir}/esopserver.spec"
  initfile="${basedir}/esopserver.init"
  destdir="/data/esop_codes/server-side"

  /bin/cp -f ${filename} ${destdir}/sbin/
  check_rc "copy to ${destdir}/sbin/${filename##*/}"

  /bin/cp -f ${specfile} ${destdir}/
  check_rc "copy to ${destdir}/${specfile##*/}"

  /bin/cp -f ${initfile} ${destdir}/
  check_rc "copy to ${destdir}/${initfile##*/}"

  server_build_dir="esop_server_build"
  /bin/rm -rf "${destdir}"/rpm_workdir/${server_build_dir}
  check_rc "remove nfs remote: ${destdir}/rpm_workdir/${server_build_dir}"

  /bin/cp -a "${basedir}/${server_build_dir}" ${destdir}/rpm_workdir/
  check_rc "copy to ${destdir}/rpm_workdir/${server_build_dir}"


  exit
elif [ "$1" == "agent" -o "$1" == "1" ]; then
  specfile="${basedir}/esop.spec"
  initfile="${basedir}/esop.init"
  destdir="/data/esop_codes/"
else
  echo "agent(1) or server(2) ?"
  exit 1
fi
autorpm="${basedir}/rpm_build/autorpm"
args="tarball"

# publish agent tarball codes
filename=$( eval "${autorpm} ${args}" )
check_rc "create tarball: ${filename}"

ls "${filename}" >/dev/null 2>&1
check_rc "check path: ${filename}"

/bin/cp -f "${filename}" "${destdir}/"
check_rc "copy to ${destdir}/${filename##*/}"


# publish spec file
/bin/cp -f "${specfile}" "${destdir}/"
check_rc "copy to ${destdir}/${specfile##*/}"


# publish init file
/bin/cp -f "${initfile}" "${destdir}/"
check_rc "copy to ${destdir}/${initfile##*/}"


# publish esop_agent_build
agent_build_dir="esop_agent_build"
/bin/rm -rf "${destdir}"/rpm_workdir/${agent_build_dir}
check_rc "remove nfs remote: ${destdir}/rpm_workdir/${agent_build_dir}"

/bin/cp -a "${basedir}/${agent_build_dir}" ${destdir}/rpm_workdir/
check_rc "copy to ${destdir}/rpm_workdir/${agent_build_dir}"

# publish esop_plugin_build
plugin_build_dir="esop_plugin_build"
/bin/rm -rf "${destdir}"/rpm_workdir/${plugin_build_dir}
check_rc "remove nfs remote: ${destdir}/rpm_workdir/${plugin_build_dir}"

/bin/cp -a "${basedir}/${plugin_build_dir}" ${destdir}/rpm_workdir/
check_rc "copy to ${destdir}/rpm_workdir/${plugin_build_dir}"

# clean rpm_build dir
${autorpm} clean
check_rc "rpm clean"

